<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Metrics</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Colossus IO Framework: Built at Tumblr">
    <link rel="canonical" href="https://github.com/tumblr/colossushttp://tumblr.github.io/colossus/docs/metrics/">

    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="imagetoolbar" content="no" />
    <link rel="stylesheet" href="http://tumblr.github.io/colossus/css/layout.css" type="text/css" />
    <script type="text/javascript" src="http://tumblr.github.io/colossus/js/jquery.js"></script>
    <script type="text/javascript" src="http://tumblr.github.io/colossus/js/jquery.innerfade.js"></script>

</head>

</head>


    <body>

    <div class="wrapper col1">
  <div id="header">
    <div id="logo">
      <h1><a href="http://tumblr.github.io/colossus/">Colossus</a></h1>
    </div>
    <div id="topnav">
      <ul>
        <li><a href="http://tumblr.github.io/colossus/about">About</a></li>
        <li><a href="http://tumblr.github.io/colossus/">Community</a></li>
        <li><a href="http://tumblr.github.io/colossus/docs">Documentation</a></li>
        <li><a href="https://github.com/tumblr/colossus">Github</a></li>
      </ul>
    </div>
    <br class="clear" />
  <p class="breaking-news"><b>Notice</b>: These docs are a work in progress.  If you see an error, <a href="https://github.com/tumblr/colossus/tree/gh-pages-source">fix it</a>!</p>
  </div>
</div>



        <div class="wrapper col3">
    <div id="container">
      <header class="post-header">
        <h1>Metrics</h1>
      </header>
      <div id="content">
        <article class="post-content">
        <p>Colossus uses the (currently nameless) metrics library.</p>

<h2 id="introduction">Introduction</h2>

<p>High-throughput Colossus services can serve hundreds of thousands of requests
per second, which can easily translate to millions of recordable events per
second.  The Metrics library provides a way to work with metrics with as little
overhead as possible.</p>

<p>The metrics library performs 3 important operations</p>

<ul>
  <li><strong>Event Collection</strong> : providing a way for user-code to signal that something worth tracking has happened</li>
  <li><strong>Metrics Aggregation</strong> : collecting raw events into metrics that can be filtered and aggregated in real-time</li>
  <li><strong>Reporting</strong> : packaging up and sending data to some external database (such as OpenTSDB)</li>
</ul>

<h2 id="basic-architecture">Basic Architecture</h2>

<p>The heart of metrics is a <code>MetricSystem</code>, which is a set of actors that handle
all of the background operations of dealing with metrics.  In most cases, you
only want to have one <code>MetricSystem</code> per application.</p>

<p>Metrics are generated periodically by a <code>Tick</code> message published on the global
event bus.  By default this happens once per second, but it can be configured
to any time interval.  So while events are being collected as they occur,
compiled metrics (such as rates and histogram percentiles) are generated once
per tick.</p>

<h3 id="structure-of-a-metric">Structure of a Metric</h3>

<p>Every metric in a system has a unique name with a url-like structure.  For
example, <code>/my-service/requests</code> and <code>/my-service/system/gc/msec</code> are two
metrics automatically generated by Colossus.  Every metric contains a set of
integer values, with each value uniquely identified by a set of key/value tags.
For example, the values for the <code>system/gc/msec</code> metric might look like</p>

<div class="highlight"><pre><code class="scala"><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">service</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">gc</span><span class="o">/</span><span class="n">msec</span>
  <span class="o">[</span><span class="k">type</span> <span class="kt">=</span> <span class="kt">ParNew</span><span class="o">]</span> <span class="k">:</span> <span class="err">123456</span>
  <span class="err">[</span><span class="k">type</span> <span class="o">=</span> <span class="nc">ConcurrentMarkSweep</span><span class="err">]</span> <span class="k">:</span> <span class="err">9876543</span></code></pre></div>

<p>Tags are immensely useful when required more fine-grained breakdown of
imformation.  A metric value can have multiple tags, values in a single metric
do not all need the same tags, and tags are optional.  We will see later that
tags can also be used to filter and aggregate values.</p>

<h2 id="getting-started">Getting Started</h2>

<p>If you are using colossus, it depends on the metrics library and pulls it in.  Otherwise you must add the following to your build.sbt/Build.scala</p>

<div class="highlight"><pre><code class="scala"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.tumblr"</span> <span class="o">%%</span> <span class="s">"metrics"</span> <span class="o">%</span> <span class="s">"0.2.0"</span></code></pre></div>

<h3 id="quickstart">Quickstart</h3>

<p>Here’s a quick demo of using the metrics system.</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">metrics._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">actor_system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>

<span class="c1">//create the metric system
</span><span class="k">val</span> <span class="n">metric_system</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">(</span><span class="s">"/my-service"</span><span class="o">)</span>

<span class="c1">//get a collection
</span><span class="k">val</span> <span class="n">collection</span> <span class="k">=</span> <span class="n">metric_system</span><span class="o">.</span><span class="n">sharedCollection</span>

<span class="c1">//now get a rate from the collection
</span><span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="n">collection</span> <span class="n">getOrAdd</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"/my-rate"</span><span class="o">,</span> <span class="n">periods</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mf">1.</span><span class="n">second</span><span class="o">,</span> <span class="mf">1.</span><span class="n">minute</span><span class="o">))</span>

<span class="c1">//fire off some events!
</span><span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span>
<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">(</span><span class="mi">25</span><span class="o">)</span>

<span class="c1">//arbitary maps of tags can be included with any event
</span><span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">(</span><span class="n">tags</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">"key"</span> <span class="o">-&gt;</span> <span class="s">"value"</span><span class="o">))</span>

<span class="c1">//by default, metrics are aggregated and snapshotted once per second
</span><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>

<span class="c1">//the snapshot is sent to an akka agent in the metric_system
</span><span class="n">println</span><span class="o">(</span><span class="n">metric_system</span><span class="o">.</span><span class="n">snapshot</span><span class="o">()(</span><span class="s">"/my-service/my-rate"</span><span class="o">)())</span></code></pre></div>

<h2 id="event-collection">Event Collection</h2>

<p>In most cases, metrics are generated from various events triggered by
application code.  For example, we can keep track of a service’s request rate
by firing an event every time a request finishes processing.  Likewise, we can
keep track of latency by adding the proccessing time of each request to a
histogram.</p>

<p>Event Collectors take the role of providing a simple API for generating events.</p>

<p>There are currently 4 built-in event collectors:</p>

<ul>
  <li>Counter - keeps track of a single number which can process increment/decrement operations</li>
  <li>Rate - A rate can be “hit” and it will track hits/second (or other time periods)</li>
  <li>Histogram - Similar to a rate, but each hit includes an integer value.  The histogram will generate percentiles/min/max over periods of time</li>
  <li>Gauge - set a static integer value</li>
</ul>

<p>Each metric has numerous configuration options to ensure the best measurements for the job.</p>

<h3 id="local-vs-shared-collectors">Local vs Shared Collectors</h3>

<p>There are two different ways to collect events.  Local event collectors run inside actors and are extremely efficient.  Shared collectors are meant to be used outside of an actor or shared amonng multiple actors, and every event becomes a single actor message.</p>

<p>In general it’s best to use local collections whenever possible, since for
example incrementing a counter is just adding 1 to a <code>Long</code>, whereas with a
shared collection every increment is a single actor message.</p>

<p>To use a LocalCollection, the easiest method is to mixin the <code>ActorMetrics</code> trait to your actors.  For example:</p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">MyActor</span><span class="o">(</span><span class="k">val</span> <span class="n">metricSystem</span><span class="k">:</span> <span class="kt">MetricSystem</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">ActorMetrics</span> <span class="o">{</span>

  <span class="c1">//the trait automatically creates a LocalCollection called metrics  
</span>  <span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="n">metrics</span> <span class="n">getOrAdd</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"/foos"</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">handleMetrics</span> <span class="n">orElse</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">"Foo"</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="k">case</span> <span class="s">"FOOOO"</span> <span class="k">=&gt;</span> <span class="nc">Future</span> <span class="o">{</span> 
      <span class="n">rate</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span> <span class="c1">//thread-safe
</span>    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre></div>

<h3 id="using-metrics-within-colossus">Using metrics within Colossus</h3>

<p>Being an actor, a Colossus event loop has it’s own <code>LocalCollection</code>.  This can be accessed through <code>context.worker.metrics</code>, for example:</p>

<div class="highlight"><pre><code class="scala"><span class="nc">Service</span><span class="o">.</span><span class="n">serve</span><span class="o">[</span><span class="kt">Http</span><span class="o">](</span><span class="s">"my-service"</span><span class="o">,</span> <span class="mi">80</span><span class="o">)</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="n">myRate</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">getOrAdd</span><span class="o">(</span><span class="nc">Rate</span><span class="o">(</span><span class="s">"my-rate"</span><span class="o">))</span>
  <span class="n">context</span><span class="o">.</span><span class="n">handle</span><span class="o">{</span> <span class="n">connection</span> <span class="k">=&gt;</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">become</span><span class="o">{</span>
      <span class="k">case</span> <span class="n">request</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hit"</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">myRate</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="s">"ok!"</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p><strong>Important</strong> - in order to properly aggregate metrics together, workers add their id as a tag to every metric.</p>

<h2 id="metric-snapshots-and-aggregation">Metric Snapshots and Aggregation</h2>

<p>As mentioned before, the Metric system will generate a snapshot once per tick,
which defaults to once per second.  The easiest way to access this snapshot is
through the <code>snapshot</code> field on the <code>MetricSystem</code>.  This is an akka agent that
contains the most recent snapshot.</p>

<p>Notice that what values actually appear in the snapshot depend on how your
event collectors are configured.  For example, if you configure a rate to
aggregate in events per minute, the rate will only update its value once per
minute regardless of the frequency configured for snapshotting.  </p>

<h2 id="metric-reporting">Metric Reporting</h2>

<p>Currently metric reporting is mostly focused on reporting to OpenTSDB.  To setup reporting you basically need 2 things:</p>

<ul>
  <li>A MetricSender - this is the object that encodes metrics to be sent</li>
  <li>A set of metric filters - These are used to select and aggregate which metrics to send</li>
</ul>

<p>In addition to OpenTSDB, metrics may also be logged to file. To use logging, change the MetricSystem to use
a LoggingSender as the metrics reporter:</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">metrics._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">actor_system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>

<span class="c1">//create the metric system
</span><span class="k">val</span> <span class="n">metric_system</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">(</span><span class="s">"/my-service"</span><span class="o">)</span>

<span class="c1">//create the config, providing LoggerSender as the MetricSender
</span><span class="k">val</span> <span class="n">metric_config</span> <span class="k">=</span> <span class="nc">MetricReporterConfig</span><span class="o">(</span><span class="nc">LoggerSender</span><span class="o">)</span>

<span class="c1">//set this as the reporting for the metric system
</span><span class="n">metric_system</span><span class="o">.</span><span class="n">report</span><span class="o">(</span><span class="n">metric_config</span><span class="o">)</span>

<span class="c1">//get a collection
</span><span class="k">val</span> <span class="n">collection</span> <span class="k">=</span> <span class="n">metric_system</span><span class="o">.</span><span class="n">sharedCollection</span>

<span class="o">//</span><span class="n">proceed</span> <span class="n">as</span> <span class="n">normal</span></code></pre></div>


        </article>
      </div>
      <div id="column">
        <div class="subnav">
          <ol class="toc"><li><a href="#introduction">Introduction</a></li><li><a href="#basic-architecture">Basic Architecture</a></li><li><a href="#getting-started">Getting Started</a></li><li><a href="#event-collection">Event Collection</a></li><li><a href="#metric-snapshots-and-aggregation">Metric Snapshots and Aggregation</a></li><li><a href="#metric-reporting">Metric Reporting</a></li></ol>
        </div>
      </div>
      <br class="clear" />
    </div>
  </div>
  <br class="clear" />



    <footer id = "footer" class="site-footer">

<div class="wrapper col5">
  <div id="copyright">
    <p class="fl_left">Copyright &copy; 2015 Tumblr - All Rights Reserved <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/3.0/80x15.png" /></a></p>
    <p class="fl_right">Based on a template by <a href="http://www.os-templates.com/" title="Free Website Templates">OS Templates</a></p>
    <br class="clear" />
  </div>
</div>

</footer>


    </body>
</html>
