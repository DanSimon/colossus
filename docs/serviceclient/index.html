<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Service Clients</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Colossus IO Framework: Built at Tumblr">
    <link rel="canonical" href="https://github.com/tumblr/colossus/pages/tumblr/colossus/docs/serviceclient/">

    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="imagetoolbar" content="no" />
    <link rel="stylesheet" href="/pages/tumblr/colossus/css/layout.css" type="text/css" />
    <script type="text/javascript" src="/pages/tumblr/colossus/js/jquery.js"></script>
    <script type="text/javascript" src="/pages/tumblr/colossus/js/jquery.innerfade.js"></script>

</head>

</head>


    <body>

    <div class="wrapper col1">
  <div id="header">
    <div id="logo">
      <h1><a href="/pages/tumblr/colossus/">Colossus</a></h1>
    </div>
    <div id="topnav">
      <ul>
        <li><a href="/pages/tumblr/colossus/about">About</a></li>
        <li><a href="/pages/tumblr/colossus/">Community</a></li>
        <li><a href="/pages/tumblr/colossus/docs">Documentation</a></li>
        <li><a href="https://github.com/tumblr/colossus">Github</a></li>
      </ul>
    </div>
    <br class="clear" />
  <p class="breaking-news"><b>Notice</b>: These docs are a work in progress.  If you see an error, <a href="https://github.ewr01.tumblr.net/Tumblr/teamscala/tree/gh-pages-source">fix it</a>!</p>
  </div>
</div>



        <div class="wrapper col3">
    <div id="container">
      <header class="post-header">
        <h1>Service Clients</h1>
      </header>
      <div id="content">
        <article class="post-content">
        <h2 id="using-service-clients">Using Service Clients</h2>

<p>There are essentially two type of service clients, <em>internal</em> clients and <em>asynchronous</em> clients.  In reality, async clients are just a wrapper around internal clients, but the use cases for each one are different.</p>

<ul>
  <li>An internal client should only be used inside a worker.  This means they should only be created inside delegators, connection handlers, or tasks.</li>
  <li>An async client is basically just an actor that is hooked up to an internal client.  Async clients are useful if code outside an IO System needs access to a client.</li>
</ul>

<h3 id="internal-client">Internal Client</h3>

<p>Internal clients are directly attached to a worker and are mostly designed for
low-latency non-blocking communication with an external system.</p>

<p>Here’s a basic example:</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">protocols.redis._</span>
  <span class="k">import</span> <span class="nn">UnifiedProtocol._</span>

  <span class="nc">Task</span><span class="o">{</span><span class="n">context</span> <span class="k">=&gt;</span> 
    <span class="k">import</span> <span class="nn">context._</span>

    <span class="c1">//setup the client
</span>    <span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">ClientConfig</span><span class="o">(</span>
      <span class="n">name</span> <span class="k">=</span> <span class="s">"/redis-client"</span><span class="o">,</span>
      <span class="n">requestTimeout</span> <span class="k">=</span> <span class="mf">50.</span><span class="n">milliseconds</span>
    <span class="o">)</span>
    <span class="k">val</span> <span class="n">redis</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServiceClient</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisClientCodec</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span> <span class="n">worker</span><span class="o">)</span>
    <span class="n">redis</span><span class="o">.</span><span class="n">connect</span><span class="o">()</span>

    <span class="c1">//this will be called when we're finished
</span>    <span class="k">def</span> <span class="n">terminate</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">println</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
      <span class="n">redis</span><span class="o">.</span><span class="n">disconnect</span><span class="o">()</span>
      <span class="n">unbind</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="c1">//send a command (non-blocking)
</span>    <span class="n">redis</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="nc">Command</span><span class="o">(</span><span class="s">"SET"</span><span class="o">,</span> <span class="s">"a_key"</span><span class="o">,</span> <span class="s">"a_value"</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">StatusReply</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">redis</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="nc">Command</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"a_key"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">BulkReply</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">terminate</span><span class="o">(</span><span class="n">s</span><span class="s">"Got ${bytes.utf8String})
        case other =&gt; terminate(s"</span><span class="nc">Invalid</span> <span class="nc">GET</span> <span class="nc">Reply</span><span class="k">:</span> <span class="kt">$other</span><span class="err">"</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="n">other</span> <span class="k">=&gt;</span> <span class="n">terminate</span><span class="o">(</span><span class="n">s</span><span class="s">"Invalid SET Reply: $other"</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></div>

<p>It is important to realize that not all of this code is executed at once, and
also that this code is completely single-threaded and non-blocking.  When the
client’s <code>send</code> method is called, you are passing to it both a command as well
as a callback for handling the reply.  The client internally buffers this and
then immediately returns.</p>

<h3 id="async-client">Async Client</h3>

<div class="highlight"><pre><code class="scala"><span class="k">implicit</span> <span class="k">val</span> <span class="n">io_system</span> <span class="k">=</span> <span class="c1">//....
</span>
<span class="c1">//setup the client
</span><span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">ClientConfig</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"/redis-client"</span><span class="o">,</span>
  <span class="n">requestTimeout</span> <span class="k">=</span> <span class="mf">50.</span><span class="n">milliseconds</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">client</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="nc">AsyncServiceClient</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RedisClientCodec</span><span class="o">)</span>

<span class="k">def</span> <span class="n">terminate</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
  <span class="n">client</span> <span class="o">!</span> <span class="nc">PoisonPill</span>
<span class="o">}</span>

<span class="o">(</span><span class="n">client</span> <span class="o">?</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"SET"</span><span class="o">,</span> <span class="s">"a_key"</span> <span class="o">,</span> <span class="s">"a_value"</span><span class="o">)).</span><span class="n">onComplete</span><span class="o">{</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">StatusReply</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">client</span> <span class="o">?</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"a_key"</span><span class="o">)).</span><span class="n">onComplete</span><span class="o">{</span>
    <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">BulkReply</span><span class="o">(</span><span class="n">data</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">terminate</span><span class="o">(</span><span class="n">s</span><span class="s">"Got ${data.utf8String}"</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">other</span> <span class="k">=&gt;</span> <span class="n">terminate</span><span class="o">(</span><span class="n">s</span><span class="s">"Invalid GET Reply: $other"</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="n">other</span> <span class="k">=&gt;</span> <span class="n">terminate</span><span class="o">(</span><span class="n">s</span><span class="s">"Invalid SET Reply: $other"</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>Here we can see we’re interacting with the client as we would with any other actor.</p>

<p>Because of the overhead of using Futures and Actors, an <code>AsyncServiceClient</code> will be considerably slower than an internal client</p>

<h2 id="monadic-callbacks">Monadic Callbacks</h2>

<p>Colossus comes with an implementation of callbacks as monads.  In the above
example of using an internal client, we’re using the standard approach to
callback.  the <code>send</code> method has the signature:</p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">ServiceClient</span><span class="o">[</span><span class="kt">Request</span>,<span class="kt">Response</span><span class="o">]</span><span class="err">...</span> <span class="o">{</span>
  
  <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">I</span><span class="o">)(</span><span class="n">handler</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>This approach, where the function takes a request and a closure as a response
handler, is very common for event-based systems.  While this approach certainly
works, it makes it very difficult to build callbacks in a functional way, since
the closure must be completely built at the time of invocation.</p>

<p>In particular, how to we handle a situation where we are building a service
server, and as part of a request we wish to call an internal client?  The
server’s <code>processRequest</code> requires us to return something, but the client’s
<code>send</code> method does not return anything.  Of course, normally this is where we
may use a <code>Future</code> (and internal clients do have a <code>sendAsync</code> method that does
return a <code>Future\[Response]</code>), but in low-latency situations, Futures can add a
significant amount of unnecessary overhead.</p>

<p>Colossus has another approach by using a <code>Callback[Response]</code> type, which at
first glance behaves a lot like a Future.  Callbacks, though, are purely designed
for the use-case of getting data between server and client connections with as
little overhead as possible, and thus are more performant in this situation.</p>

<p><em>NOTE - It’s important to realize that callbacks are an optimization which can
give a significant performance boost, but like any specialized optimization
they come with drawbacks.  When in doubt, use Futures</em></p>

<p>Clients have another method called <code>sendCB</code></p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">ServiceClient</span><span class="o">[</span><span class="kt">Request</span>,<span class="kt">Response</span><span class="o">]</span><span class="err">...</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">sendCB</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span><span class="k">:</span> <span class="kt">Callback</span><span class="o">[</span><span class="kt">Try</span><span class="o">[</span><span class="kt">Response</span><span class="o">]]</span>

<span class="o">}</span></code></pre></div>

<p>This approach allows you to make a request to a service client and return the
callback in your service server.  Callbacks have a the usual monadic transformaers:</p>

<div class="highlight"><pre><code class="scala"><span class="k">trait</span> <span class="nc">Callback</span><span class="o">[</span><span class="kt">O</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">U</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">O</span> <span class="o">=&gt;</span> <span class="n">U</span><span class="o">)</span><span class="k">:</span> <span class="kt">Callback</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">U</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">O</span> <span class="o">=&gt;</span> <span class="nc">Callback</span><span class="o">[</span><span class="kt">U</span><span class="o">])</span><span class="k">:</span> <span class="kt">Callback</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span>
<span class="o">}</span></code></pre></div>

<p>as well as some useful utility functions</p>

<div class="highlight"><pre><code class="scala"><span class="k">object</span> <span class="nc">Callback</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">sequence</span><span class="o">[</span><span class="kt">O</span><span class="o">](</span><span class="n">callbacks</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Callback</span><span class="o">[</span><span class="kt">O</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Callback</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">O</span><span class="o">]]</span>
  <span class="k">def</span> <span class="n">done</span><span class="o">[</span><span class="kt">O</span><span class="o">](</span><span class="n">value</span><span class="k">:</span> <span class="kt">O</span><span class="o">)</span><span class="k">:</span> <span class="kt">Callback</span><span class="o">[</span><span class="kt">O</span><span class="o">]</span>
<span class="o">}</span></code></pre></div>


        </article>
      </div>
      <div id="column">
        <div class="subnav">
          <ol class="toc"><li><a href="#using-service-clients">Using Service Clients</a></li><li><a href="#monadic-callbacks">Monadic Callbacks</a></li></ol>
        </div>
      </div>
      <br class="clear" />
    </div>
  </div>
  <br class="clear" />



    <footer id = "footer" class="site-footer">

<div class="wrapper col5">
  <div id="copyright">
    <p class="fl_left">Copyright &copy; 2014 Tumblr - All Rights Reserved <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/3.0/80x15.png" /></a></p>
    <p class="fl_right">Based on a template by <a href="http://www.os-templates.com/" title="Free Website Templates">OS Templates</a></p>
    <br class="clear" />
  </div>
</div>

</footer>


    </body>
</html>
